<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="description" content="Byte Buddy æ•™ç¨‹ -- Byte Buddy æ˜¯ä¸€ä¸ªå­—èŠ‚ç ç”Ÿæˆä¸ç»´æŠ¤çš„åº“ï¼Œä¸»è¦ç”¨äºåœ¨ Java åº”ç”¨è¿è¡Œæ—¶ç”Ÿæˆå’Œä¿®æ”¹ Java ç±»ï¼Œå¹¶ä¸”ä¸éœ€è¦ç¼–è¯‘å™¨æ¥è¾…åŠ©ã€‚">
<meta name="keywords" content="Byte Buddy Tutorial, Byte Buddy æ•™ç¨‹, å­—èŠ‚ç , Java, JVM, Java Virtual Machine, Java è™šæ‹Ÿæœº">
<meta name="author" content="Dç“œå“¥">
<title>Byte Buddy æ•™ç¨‹ Alpha</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="assets/styles/asciidoctor.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="assets/styles/rouge-github.css">
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
<script>var _hmt = _hmt || [];(function () {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?ae79ae5854e141fa6c9a217b5dcf0e45";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();</script></head>
<body id="creating-a-class" class="book toc2 toc-left">
<div id="header">
<h1>Byte Buddy æ•™ç¨‹ <sup>Alpha</sup></h1>
<div class="details">
<span id="author" class="author">Dç“œå“¥</span><br>
<span id="email" class="email"><a href="https://www.diguage.com/" class="bare">https://www.diguage.com/</a></span><br>
<span id="revnumber">v 0.1.0,</span>
<span id="revdate">2017-07-24</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">ç›®å½•</div>
<p><span class="toc-root"><a href="index.html">Byte Buddy æ•™ç¨‹ <sup>Alpha</sup></a></span></p><ul class="sectlevel1">
<li><a href="preface.html">å‰è¨€</a>
</li>
<li><a href="preliminary.html">ä¸ºä»€ä¹ˆéœ€è¦åœ¨è¿è¡Œæ—¶ç”Ÿæˆä»£ç ï¼Ÿ</a>
</li>
<li><a href="creating-a-class.html"><span class="toc-current">åˆ›å»ºä¸€ä¸ªç±»</span></a>
<ul class="sectlevel2">
<li><a href="creating-a-class.html#domain-specific-language-and-immutability">é¢†åŸŸç‰¹å®šè¯­è¨€å’Œä¸å˜æ€§</a>
</li>
<li><a href="creating-a-class.html#redefining-and-rebasing-existing-classes">é‡æ–°å®šä¹‰æˆ–è€…é‡å®šåŸºåº•å·²ç»å­˜åœ¨çš„ç±»</a>
</li>
<li><a href="creating-a-class.html#loading-a-class">åŠ è½½ç±»</a>
</li>
<li><a href="creating-a-class.html#reloading-a-class">é‡æ–°åŠ è½½ç±»</a>
</li>
<li><a href="creating-a-class.html#working-with-unloaded-classes">æ“ä½œæ²¡æœ‰åŠ è½½çš„ç±»</a>
</li>
<li><a href="creating-a-class.html#creating-java-agents">åˆ›å»º Java Agents</a>
</li>
<li><a href="creating-a-class.html#loading-classes-in-android-applications">åœ¨ Android åº”ç”¨ä¸­åŠ è½½ç±»</a>
</li>
<li><a href="creating-a-class.html#working-with-generic-types">ä½¿ç”¨æ³›å‹ç±»</a>
</li>
</ul>
</li>
<li><a href="fields-and-methods.html">å±æ€§å’Œæ–¹æ³•</a>
</li>
<li><a href="annotations.html">æ³¨è§£</a>
</li>
<li><a href="custom-instrumentation.html">å®šåˆ¶åŒ–ä»ªè¡¨</a>
</li>
<li><a href="license.html">é™„å½• B: ç‰ˆæƒå£°æ˜</a>
</li>
</ul>
</div>
</div>
<div id="content"><div class="sect2"><h3 id="_å‹æƒ…æ”¯æŒ">å‹æƒ…æ”¯æŒ</h3><div class="paragraph"><p>å¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªç¬”è®°å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œçœ‹åœ¨Dç“œå“¥ç è¿™ä¹ˆå¤šå­—çš„è¾›è‹¦ä¸Šï¼Œè¯·å‹æƒ…æ”¯æŒä¸€ä¸‹ï¼ŒDç“œå“¥æ„Ÿæ¿€ä¸å°½ï¼ŒğŸ˜œ</p></div><table class="tableblock frame-none grid-all stretch"><colgroup><col style="width: 50%;"><col style="width: 50%;"></colgroup><tbody><tr><td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="assets/images/alipay.png" alt="æ”¯ä»˜å®" width="85%" title="æ”¯ä»˜å®"></span></p></td><td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="assets/images/wxpay.jpg" alt="å¾®ä¿¡" width="85%" title="å¾®ä¿¡"></span></p></td></tr></tbody></table><div class="paragraph"><p>æœ‰äº›æ‰“èµçš„æœ‹å‹å¸Œæœ›å¯ä»¥åŠ ä¸ªå¥½å‹ï¼Œæ¬¢è¿å…³æ³¨D ç“œå“¥çš„å¾®ä¿¡å…¬ä¼—å·ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡å…¬ä¼—å·çš„å›å¤ç›´æ¥ç»™æˆ‘å‘ä¿¡æ¯ã€‚</p></div><div class="paragraph"><p><span class="image"><img src="assets/images/wx-jikerizhi.png" alt="wx jikerizhi" width="98%"></span></p></div><div class="admonitionblock tip"><table><tbody><tr><td class="icon"><i class="fa icon-tip" title="Tip"></i></td><td class="content"><strong>å…¬ä¼—å·çš„å¾®ä¿¡å·æ˜¯: <code>jikerizhi</code></strong>ã€‚<em>å› ä¸ºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œæœ‰æ—¶å›¾ç‰‡åŠ è½½ä¸å‡ºæ¥ã€‚ å¦‚æœå›¾ç‰‡åŠ è½½ä¸å‡ºæ¥å¯ä»¥ç›´æ¥é€šè¿‡æœç´¢å¾®ä¿¡å·æ¥æŸ¥æ‰¾æˆ‘çš„å…¬ä¼—å·ã€‚</em></td></tr></tbody></table></div></div>
<div class="sect1">
<h2 id="creating-a-class"><a class="anchor" href="#creating-a-class"></a>åˆ›å»ºä¸€ä¸ªç±»</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ä»»ä½•ä¸€ä¸ªç”± Byte Buddy åˆ›å»ºçš„ç±»å‹éƒ½æ˜¯é€šè¿‡ <code>ByteBuddy</code> ç±»çš„å®ä¾‹æ¥å®Œæˆçš„ã€‚é€šè¿‡ç®€å•åœ°è°ƒç”¨ <code>new ByteBuddy()</code> å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹ï¼Œç„¶åå°±å¯ä»¥å‡ºå‘äº†ã€‚å¸Œæœ›ä½ ä½¿ç”¨ä¸€ä¸ªé›†æˆå¼€å‘ç¯å¢ƒï¼Œè¿™æ ·åœ¨è°ƒç”¨ä¸€ä¸ªç»™å®šå®ä¾‹çš„æ–¹æ³•æ—¶å°±èƒ½å¾—åˆ°ç›¸åº”çš„æç¤ºã€‚è¿™æ ·ï¼Œä½ çš„é›†æˆå¼€å‘ç¯å¢ƒå°±ä¼šå¼•å¯¼ä½ å®Œæˆç›¸åº”çš„æ–¹æ³•è°ƒç”¨ï¼Œé˜²æ­¢æ‰‹åŠ¨åœ¨ Byte Buddy æ–‡æ¡£ä¸­æŸ¥é˜…æŸä¸ªç±»çš„ APIã€‚æ­£å¦‚ä¹‹å‰æ‰€è¯´ï¼ŒByte Buddy æä¾›äº†ä¸€ä¸ªé¢†åŸŸç‰¹å®šè¯­è¨€ï¼Œè¿™æ ·å°±å¯ä»¥å°½å¯èƒ½åœ°æé«˜äººç±»å¯è¯»æ€§ã€‚é›†æˆå¼€å‘ç¯å¢ƒçš„æç¤ºåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šæŒ‡å¼•ä½ åˆ°æ­£ç¡®çš„æ–¹å‘ã€‚è¯´çš„å¤Ÿå¤šäº†ï¼Œè®©æˆ‘ä»¬åœ¨ Java ç¼–ç¨‹ç¯å¢ƒä¸­åˆ›å»ºç¬¬ä¸€ä¸ªç±»å§ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="nc">DynamicType</span><span class="o">.</span><span class="na">Unloaded</span><span class="o">&lt;?&gt;</span> <span class="n">dynamicType</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteBuddy</span><span class="o">()</span>
  <span class="o">.</span><span class="na">subclass</span><span class="o">(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">make</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>æ­£å¦‚å‰é¢æ‰€è®¾æƒ³çš„ï¼Œä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¼šåˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡³ <code>Object</code> ç±»å‹çš„ç±»ã€‚è¿™ä¸ªåŠ¨æ€åˆ›å»ºçš„ç±»å‹ä¸ç›´æ¥æ‰©å±• <code>Object</code> å¹¶ä¸”æ²¡æœ‰å®ç°ä»»ä½•æ–¹æ³•ã€å±æ€§å’Œæ„é€ å‡½æ•°çš„ç±»å‹æ˜¯ç­‰ä»·çš„ã€‚ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬éƒ½æ²¡æœ‰å‘½ååŠ¨æ€ç”Ÿæˆçš„ç±»å‹ï¼Œé€šå¸¸åœ¨å®šä¹‰ Java ç±»æ—¶å´æ˜¯å¿…é¡»çš„ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥å¾ˆå®¹æ˜“åœ°æ˜ç¡®åœ°å‘½åè¿™ä¸ªç±»å‹ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="nc">DynamicType</span><span class="o">.</span><span class="na">Unloaded</span><span class="o">&lt;?&gt;</span> <span class="n">dynamicType</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteBuddy</span><span class="o">()</span>
  <span class="o">.</span><span class="na">subclass</span><span class="o">(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"example.Type"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">make</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>å¦‚æœæ²¡æœ‰æ˜ç¡®çš„å‘½åä¼šæ€ä¹ˆæ ·å‘¢ï¼ŸByte Buddy ä¸ <a href="https://en.wikipedia.org/wiki/Convention_over_configuration" target="_blank" rel="noopener">çº¦å®šå¤§äºé…ç½®</a> æ¯æ¯ç›¸å…³ï¼Œä¸ºä½ æä¾›äº†æˆ‘ä»¬è®¤ä¸ºæ¯”è¾ƒæ–¹ä¾¿çš„é»˜è®¤é…ç½®ã€‚è‡³äºç±»å‹å‘½åï¼ŒByte Buddy çš„é»˜è®¤é…ç½®æä¾›äº† <code>NamingStrategy</code>ï¼Œå®ƒåŸºäºåŠ¨æ€ç±»å‹çš„è¶…ç±»åç§°æ¥éšæœºç”Ÿæˆç±»åã€‚æ­¤å¤–ï¼Œåç§°å®šä¹‰åœ¨ä¸çˆ¶ç±»ç›¸åŒçš„åŒ…ä¸‹ï¼Œè¿™æ ·çˆ¶ç±»çš„åŒ…çº§è®¿é—®æƒé™çš„æ–¹æ³•å¯¹åŠ¨æ€ç±»å‹ä¹Ÿå¯è§ã€‚å¦‚æœä½ å°†ç¤ºä¾‹å­ç±»å‘½åä¸º <code>example.Foo</code>ï¼Œé‚£ä¹ˆç”Ÿæˆçš„åç§°å°†ä¼šç±»ä¼¼äº <code>example.FooByteBuddy1376491271</code>ï¼Œè¿™é‡Œçš„æ•°å­—åºåˆ—æ˜¯éšæœºçš„ã€‚è¿™ä¸ªè§„åˆ™çš„ä¾‹å¤–æƒ…å†µå°±æ˜¯å½“å­ç±»æ˜¯ä» <code>java.lang</code> åŒ…ä¸‹çš„ç±»æ‰©å±•æ—¶ï¼Œå°±æ˜¯ <code>Object</code> æ‰€åœ¨çš„åŒ…ã€‚Java çš„å®‰å…¨æ¨¡å‹ä¸å…è®¸è‡ªå®šä¹‰ç±»å‹å­˜æ”¾åœ¨è¿™ä¸ªå‘½åç©ºé—´ä¸‹ã€‚å› æ­¤ï¼Œé»˜è®¤å‘½åç­–ç•¥ä¸‹ï¼Œè¿™äº›ç±»å‹åç§°å°†ä¼šå† ä»¥ <code>net.bytebuddy.renamed</code> çš„å‰ç¼€ã€‚</p>
</div>
<div class="paragraph">
<p>é»˜è®¤è¡Œä¸ºä¹Ÿè®¸å¯¹ä½ æ¥è¯´å¹¶ä¸æ–¹ä¾¿ã€‚æ„Ÿè°¢çº¦å®šå¤§äºé…ç½®åŸåˆ™ï¼Œä½ æ€»æ˜¯å¯ä»¥æ ¹æ®ä½ çš„éœ€è¦æ¥é€‰æ‹©é»˜è®¤è¡Œä¸ºã€‚è¿™æ­£æ˜¯ <code>ByteBuddy</code> çš„ä¼˜è¶Šä¹‹å¤„ã€‚é€šè¿‡ <code>new ByteBuddy()</code> åˆ›å»ºå®ä¾‹ï¼Œä½ å°±åˆ›å»ºäº†æ•´å¥—çš„é»˜è®¤é…ç½®ã€‚é€šè¿‡è°ƒç”¨åœ¨è¿™ä¸ªé…ç½®ä¸Šçš„æ–¹æ³•ï¼Œä½ å°±å¯ä»¥æ ¹æ®ä½ çš„éœ€è¦æ¥è®¢åˆ¶å®ƒã€‚è®©æˆ‘ä»¬è¯•è¯•ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="nc">DynamicType</span><span class="o">.</span><span class="na">Unloaded</span><span class="o">&lt;?&gt;</span> <span class="n">dynamicType</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteBuddy</span><span class="o">()</span>
  <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="k">new</span> <span class="nc">NamingStrategy</span><span class="o">.</span><span class="na">AbstractBase</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">name</span><span class="o">(</span><span class="nc">TypeDescription</span> <span class="n">superClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"i.love.ByteBuddy."</span> <span class="o">+</span> <span class="n">superClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">})</span>
  <span class="o">.</span><span class="na">subclass</span><span class="o">(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">make</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>åœ¨ä¸Šé¢è¿™é‡Œä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„é…ç½®ï¼Œåœ¨ç±»å‹å‘½åæ–¹é¢ï¼Œä¸åŒäºé»˜è®¤é…ç½®ã€‚åŒ¿åç±»è¢«ç®€å•å®ç°ä¸ºè¿æ¥ <code>i.love.ByteBuddy</code> å’ŒåŸºç±»çš„ç®€è¦åç§°ã€‚å½“æ‰©å±• <code>Object</code> ç±»å‹æ—¶ï¼ŒåŠ¨æ€ç±»å°†è¢«å‘½åä¸º <code>i.love.ByteBuddy.Object</code>ã€‚å½“åˆ›å»ºè‡ªå·±çš„å‘½åç­–ç•¥æ—¶ï¼Œéœ€è¦ç‰¹åˆ«å°å¿ƒã€‚Java è™šæ‹Ÿæœºå°±æ˜¯ä½¿ç”¨åå­—æ¥åŒºåˆ†ä¸åŒçš„ç±»å‹çš„ï¼Œè¿™æ­£æ˜¯ä¸ºä»€ä¹ˆè¦é¿å…å‘½åå†²çªçš„åŸå› ã€‚å¦‚æœä½ éœ€è¦å®šåˆ¶å‘½åè¡Œä¸ºï¼Œè¯·è€ƒè™‘ä½¿ç”¨ Byte Buddy å†…ç½®çš„ <code>NamingStrategy.SuffixingRandom</code>ï¼Œä½ å¯ä»¥é€šè¿‡å¼•å…¥æ¯”é»˜è®¤å¯¹ä½ åº”ç”¨æ›´æœ‰æ„ä¹‰çš„å‰ç¼€æ¥å®šåˆ¶å‘½åè¡Œä¸ºã€‚</p>
</div>
<div class="sect2">
<h3 id="domain-specific-language-and-immutability"><a class="anchor" href="#domain-specific-language-and-immutability"></a>é¢†åŸŸç‰¹å®šè¯­è¨€å’Œä¸å˜æ€§</h3>
<div class="paragraph">
<p>åœ¨çœ‹è¿‡ Byte Buddy è¿™ç§é¢†åŸŸç‰¹å®šè¯­è¨€çš„å®é™…æ•ˆæœä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ç®€è¦çœ‹ä¸€ä¸‹è¿™ç§è¯­è¨€çš„å®ç°æ–¹å¼ã€‚æœ‰ä¸€ä¸ªç»†èŠ‚éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œè¿™ä¸ªè¯­è¨€æ˜¯å›´ç»• <a href="https://en.wikipedia.org/wiki/Immutable_object" target="_blank" rel="noopener">ä¸å¯å˜å¯¹è±¡</a> æ„å»ºçš„ã€‚äº‹å®ä¸Šï¼ŒByte Buddy ä¸­ï¼Œå‡ ä¹æ‰€æœ‰çš„ç±»éƒ½è¢«æ„å»ºæˆä¸å¯å˜çš„ï¼›æå°‘æ•°æƒ…å†µï¼Œæˆ‘ä»¬ä¸å¯èƒ½æŠŠå¯¹è±¡æ„å»ºæˆä¸å¯å˜çš„ï¼Œæˆ‘ä»¬ä¼šåœ¨è¯¥ç±»çš„æ–‡æ¡£ä¸­æ˜ç¡®æŒ‡å‡ºã€‚å¦‚æœä½ ä¸º Byte Buddy å®ç°è‡ªå®šä¹‰åŠŸèƒ½ï¼Œæˆ‘ä»¬å»ºè®®ä½ éµå®ˆæ­¤åŸåˆ™ã€‚</p>
</div>
<div class="paragraph">
<p>ä½œä¸ºæ‰€æåˆ°çš„ä¸å¯å˜æ€§çš„å«ä¹‰ï¼Œä¾‹å¦‚é…ç½® <code>ByteBuddy</code> å®ä¾‹æ—¶ï¼Œä¸€å®šè¦å°å¿ƒã€‚ä½ ä¹Ÿè®¸ä¼šçŠ¯ä¸‹é¢çš„é”™è¯¯ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="nc">ByteBuddy</span> <span class="n">byteBuddy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteBuddy</span><span class="o">();</span>
<span class="n">byteBuddy</span><span class="o">.</span><span class="na">withNamingStrategy</span><span class="o">(</span><span class="k">new</span> <span class="nc">NamingStrategy</span><span class="o">.</span><span class="na">SuffixingRandom</span><span class="o">(</span><span class="s">"suffix"</span><span class="o">));</span>
<span class="nc">DynamicType</span><span class="o">.</span><span class="na">Unloaded</span><span class="o">&lt;?&gt;</span> <span class="n">dynamicType</span> <span class="o">=</span> <span class="n">byteBuddy</span><span class="o">.</span><span class="na">subclass</span><span class="o">(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">make</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä½ æˆ–è®¸å¸Œæœ›ä½¿ç”¨ <code>new NamingStrategy.SuffixingRandom("suffix")</code> æ¥è‡ªå®šä¹‰åŠ¨æ€ç±»å‹çš„å‘½åç­–ç•¥ã€‚ä¸æ˜¯ä¿®æ”¹å­˜å‚¨åœ¨ <code>byteBuddy</code> å˜é‡ä¸­çš„å®ä¾‹ï¼Œè°ƒç”¨ <code>withNamingStrategy</code> æ–¹æ³•è¿”å›ä¸€ä¸ªè‡ªå®šä¹‰çš„ <code>ByteBuddy</code> å®ä¾‹ï¼Œä½†æ˜¯å®ƒå´ç›´æ¥è¢«ä¸¢å¼ƒäº†ã€‚ç»“æœï¼Œè¿˜æ˜¯ä½¿ç”¨åŸæ¥åˆ›å»ºçš„é»˜è®¤é…ç½®æ¥åˆ›å»ºåŠ¨æ€ç±»å‹ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="redefining-and-rebasing-existing-classes"><a class="anchor" href="#redefining-and-rebasing-existing-classes"></a>é‡æ–°å®šä¹‰æˆ–è€…é‡å®šåŸºåº•å·²ç»å­˜åœ¨çš„ç±»</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Dç“œå“¥æ³¨</strong></p>
</div>
<div class="paragraph">
<p><strong><code>type rebasing</code></strong> ä¸çŸ¥å¦‚ä½•ç¿»è¯‘æ˜¯å¥½ï¼Œæš‚ä¸”ç¿»è¯‘ä¸ºâ€œ<strong>é‡å®šåŸºåº•</strong>â€ã€‚ä¸‹æ–‡ä¸­ï¼Œæ ¹æ®è¯­å¥é€šé¡ºéœ€è¦ï¼Œå¶å°”ä¹Ÿç¿»è¯‘æˆâ€œ<strong>é‡å®šä¹‰</strong>â€ã€‚å¦‚æœæœ‰å¥½çš„ç¿»è¯‘ï¼Œæ¬¢è¿ç»™å‘PRã€‚</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä»…ä»…æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Byte Buddy æ¥åˆ›å»ºå·²çŸ¥ç±»çš„å­ç±»ã€‚ç›¸åŒçš„ API è¿˜å¯ç”¨äºå¢å¼ºå·²æœ‰ç±»ã€‚å¢åŠ å·²æœ‰ç±»æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ç±»å‹é‡å®šä¹‰ï¼ˆtype redefinitionï¼‰</dt>
<dd>
<p>å½“é‡å®šä¹‰ä¸€ä¸ªç±»æ—¶ï¼ŒByte Buddy å¯ä»¥å¯¹ä¸€ä¸ªå·²æœ‰çš„ç±»æ·»åŠ å±æ€§å’Œæ–¹æ³•ï¼Œæˆ–è€…åˆ é™¤å·²ç»å­˜åœ¨çš„æ–¹æ³•å®ç°ã€‚å¦‚æœä½¿ç”¨å…¶ä»–çš„æ–¹æ³•å®ç°æ›¿æ¢å·²ç»å­˜åœ¨çš„æ–¹æ³•å®ç°ï¼Œåˆ™åŸæ¥å­˜åœ¨çš„æ–¹æ³•å®ç°å°±ä¼šæ¶ˆå¤±ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬é‡å®šä¹‰ä¸‹é¢è¿™ä¸ªç±»å‹</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="nf">bar</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="s">"bar"</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä» <code>bar</code> æ–¹æ³•è¿”å› <code>"qux"</code>ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•åŸæ¥è¿”å›çš„ <code>"bar"</code> ç­‰ä¿¡æ¯å°±ä¼šéƒ½è¢«ä¸¢å¤±æ‰ã€‚</p>
</div>
</dd>
<dt class="hdlist1">ç±»å‹é‡å®šåŸºåº•ï¼ˆtype rebasingï¼‰</dt>
<dd>
<p>å½“é‡å®šåŸºåº•ä¸€ä¸ªç±»æ—¶ï¼ŒByte Buddy ä¿å­˜åŸºåº•ç±»æ‰€æœ‰æ–¹æ³•çš„å®ç°ã€‚å½“ Byte Buddy å¦‚æ‰§è¡Œç±»å‹é‡å®šä¹‰æ—¶ï¼Œå®ƒå°†æ‰€æœ‰è¿™äº›æ–¹æ³•å®ç°å¤åˆ¶åˆ°å…·æœ‰å…¼å®¹ç­¾åçš„é‡æ–°å‘½åçš„ç§æœ‰æ–¹æ³•ä¸­ï¼Œè€Œä¸æ˜¯æŠ›å¼ƒé‡å†™çš„æ–¹æ³•ã€‚è¿™æ ·ï¼Œå°±æ²¡æœ‰å®ç°ä¼šè¢«ä¸¢å¤±ã€‚é‡å®šä¹‰çš„æ–¹æ³•å¯ä»¥ç»§ç»­é€šè¿‡å®ƒä»¬é‡å‘½åè¿‡çš„åç§°è°ƒç”¨åŸæ¥çš„æ–¹æ³•ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¸Šè¿° <code>Foo</code> ç±»å°±ä¼šè¢«é‡å®šä¹‰æˆä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="nf">bar</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="s">"foo"</span> <span class="o">+</span> <span class="n">bar$original</span><span class="o">();</span> <span class="o">}</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">bar$original</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="s">"bar"</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>åŸæ¥è¿”å› <code>bar</code> çš„æ–¹æ³•è¢«ä¿å­˜åˆ°äº†å¦å¤–ä¸€ä¸ªæ–¹æ³•é‡Œï¼Œå› æ­¤è¿˜å¯ä»¥è®¿é—®ã€‚å½“é‡å®šåŸºåº•ä¸€ä¸ªç±»æ—¶ï¼ŒByte Buddy å¯¹å¾…æ‰€æœ‰æ–¹æ³•å®šä¹‰å°±åƒä½ å®šä¹‰ä¸€ä¸ªå­ç±»ä¸€æ ·ï¼Œä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³è°ƒç”¨é‡å®šä¹‰æ–¹æ³•çš„è¶…ç±»æ–¹æ³•æ˜¯ï¼Œå®ƒä¼šè°ƒç”¨è¢«é‡å®šä¹‰çš„æ–¹æ³•ã€‚<em>ç›¸åï¼Œå®ƒæœ€ç»ˆå°†è¿™ä¸ªå‡è®¾çš„è¶…çº§ç±»åˆ«å˜æˆäº†ä¸Šé¢æ˜¾ç¤ºçš„é‡å®šä¹‰ç±»å‹ã€‚</em></p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>ä»»ä½•é‡å®šåŸºåº•ã€é‡å®šä¹‰æˆ–å­ç±»éƒ½æ˜¯ä½¿ç”¨ç›¸åŒçš„ API æ¥æ‰§è¡Œï¼Œæ¥å£ç”± <code>DynamicType.Builder</code> æ¥å®šä¹‰ã€‚<em>è¿™æ ·ï¼Œå¯ä»¥å°†ç±»å®šä¹‰ä¸ºå­ç±»ï¼Œç„¶åæ›´æ”¹ä»£ç æ¥æ›¿æ¢é‡å®šç±»ã€‚</em>ä½ åªéœ€è¦ä¿®æ”¹ Byte Buddy é¢†åŸŸç‰¹å®šè¯­è¨€çš„ä¸€ä¸ªå•è¯å°±èƒ½è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚è¿™æ ·ï¼Œåœ¨å®šä¹‰çš„æœªæ¥é˜¶æ®µï¼Œä½ å°±å¯ä»¥é€æ˜åœ°åˆ‡æ¢ä»»ä½•ä¸€ç§æ–¹æ³•ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="k">new</span> <span class="nc">ByteBuddy</span><span class="o">().</span><span class="na">subclass</span><span class="o">(</span><span class="nc">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="k">new</span> <span class="nf">ByteBuddy</span><span class="o">().</span><span class="na">redefine</span><span class="o">(</span><span class="nc">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="k">new</span> <span class="nf">ByteBuddy</span><span class="o">().</span><span class="na">rebase</span><span class="o">(</span><span class="nc">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>è¿™åœ¨æœ¬æ•™ç¨‹çš„å…¶ä½™éƒ¨åˆ†éƒ½æœ‰æ‰€è§£é‡Šã€‚å› ä¸ºå®šä¹‰å­ç±»å¯¹äº Java å¼€å‘äººå‘˜æ¥è¯´æ˜¯å¦‚æ­¤åœ°ç†Ÿæ‚‰ï¼Œæ‰€ä»¥ï¼Œæ¥ä¸‹æ¥çš„æ‰€æœ‰è§£é‡Šä»¥åŠ Byte Buddy é¢†åŸŸç‰¹å®šè¯­è¨€çš„å®ä¾‹éƒ½æ˜¯ç”¨åˆ›å»ºå­ç±»æ¥æ¼”ç¤ºã€‚ä½†æ˜¯ï¼Œè¯·è®°ä½ï¼Œæ‰€æœ‰ç±»å¯ä»¥ç±»ä¼¼åœ°é€šè¿‡é‡å®šä¹‰æˆ–é‡å®šåŸºç±»æ¥å®šä¹‰ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="loading-a-class"><a class="anchor" href="#loading-a-class"></a>åŠ è½½ç±»</h3>
<div class="paragraph">
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªå®šä¹‰å¹¶åˆ›å»ºäº†ä¸€ä¸ªåŠ¨æ€ç±»å‹ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨å®ƒã€‚ç”± Byte Buddy åˆ›å»ºçš„ç±»å‹ä½¿ç”¨ <code>DynamicType.Unloaded</code> çš„å®ä¾‹è¡¨ç¤ºã€‚é¡¾åæ€ä¹‰ï¼Œè¿™äº›ç±»å‹ä¸ä¼šåŠ è½½åˆ° Java è™šæ‹Ÿæœºä¸­ã€‚ç›¸åï¼Œç”± Byte Buddy åˆ›å»ºçš„ç±»ä»¥äºŒè¿›åˆ¶ï¼ŒJava ç±»æ–‡ä»¶æ ¼å¼å½¢å¼è¡¨ç¤ºã€‚è¿™æ ·ï¼Œæ‚¨å¯ä»¥å†³å®šè¦ä½¿ç”¨ç”Ÿæˆçš„ç±»å‹åšä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ä»æ„å»ºè„šæœ¬è¿è¡Œ Byte Buddyï¼Œè¯¥è„šæœ¬ä»…åœ¨éƒ¨ç½²ä¹‹å‰ç”Ÿæˆ Java ç±»ä»¥å¢å¼ºåº”ç”¨ç¨‹åºã€‚ä¸ºæ­¤ï¼Œ<code>DynamicType.Unloaded</code> ç±»å…è®¸æå–è¡¨ç¤ºåŠ¨æ€ç±»å‹çš„å­—èŠ‚æ•°ç»„ã€‚ä¸ºæ–¹ä¾¿èµ·è§ï¼Œè¯¥ç±»å‹è¿˜æä¾›äº†ä¸€ä¸ª <code>saveIn(File)</code> æ–¹æ³•ï¼Œå¯ä»¥å°†ç±»å­˜å‚¨åœ¨ç»™å®šçš„æ–‡ä»¶å¤¹ä¸­ã€‚æ­¤å¤–ï¼Œå®ƒå…è®¸æ‚¨ä½¿ç”¨ <code>inject(File)</code> æ–¹æ³•å°†ç±»æ³¨å…¥åˆ°ç°æœ‰çš„ Jar æ–‡ä»¶ä¸­ã€‚</p>
</div>
<div class="paragraph">
<p>å°½ç®¡ç›´æ¥è®¿é—®ç±»çš„äºŒè¿›åˆ¶å½¢å¼ç®€å•ç›´æ¥ï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼ŒåŠ è½½ç±»å‹å´éå¸¸å¤æ‚ã€‚åœ¨ Java ä¸­ï¼Œæ‰€æœ‰çš„ç±»éƒ½ä½¿ç”¨ <code>ClassLoader</code> æ¥åŠ è½½ã€‚è¿™ç§ç±»åŠ è½½å™¨çš„ä¸€ä¸ªä¾‹å­æ˜¯å¼•å¯¼ç±»åŠ è½½å™¨ï¼Œå®ƒè´Ÿè´£åŠ è½½ Java ç±»åº“ä¸­å‘å¸ƒçš„ç±»ã€‚å¦ä¸€æ–¹é¢ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨è´Ÿè´£åŠ è½½åœ¨ Java åº”ç”¨ç¨‹åºçš„ç±»è·¯å¾„ä¸Šçš„ç±»ã€‚æ˜¾ç„¶ï¼Œè¿™äº›å…ˆå‰å­˜åœ¨çš„ç±»åŠ è½½å™¨éƒ½ä¸çŸ¥é“æˆ‘ä»¬åˆ›å»ºçš„ä»»ä½•åŠ¨æ€ç±»ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»æ‰¾åˆ°èƒ½åŠ è½½è¿è¡Œæ—¶ç”Ÿæˆç±»çš„å…¶ä»–å¯èƒ½æ€§ã€‚ Byte Buddy é€šè¿‡ä¸åŒçš„æ–¹æ³•æä¾›è§£å†³æ–¹æ¡ˆï¼š</p>
</div>
<div class="ulist">
<ul>
<li>
<p>æˆ‘ä»¬ç®€å•åœ°åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>ClassLoader</code>ï¼Œå¹¶æ˜ç¡®åœ°å‘ŠçŸ¥å®ƒä¸€ä¸ªç‰¹å®šåŠ¨æ€åˆ›å»ºçš„ç±»çš„å­˜åœ¨ä½ç½®ã€‚å› ä¸º Java ç±»åŠ è½½å™¨æ˜¯ä»¥å±‚æ¬¡ç»“æ„ç»„ç»‡çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æ­¤ç±»åŠ è½½å™¨å®šä¹‰ä¸ºè¿è¡Œä¸­çš„ Java åº”ç”¨ç¨‹åºä¸­å·²ç»å­˜åœ¨çš„ç»™å®šç±»åŠ è½½å™¨çš„å­ç±»ã€‚è¿™æ ·ï¼Œè¿è¡Œçš„Javaç¨‹åºçš„æ‰€æœ‰ç±»å‹å¯¹äºä½¿ç”¨æ–°çš„ <code>ClassLoader</code> åŠ è½½çš„åŠ¨æ€ç±»å‹éƒ½æ˜¯å¯è§çš„ã€‚</p>
</li>
<li>
<p>é€šå¸¸ï¼ŒJava ç±»åŠ è½½å™¨åœ¨å°è¯•ç›´æ¥åŠ è½½ç»™å®šåç§°çš„ç±»å‹ä¹‹å‰æŸ¥è¯¢å…¶åŒäº² <code>ClassLoader</code>ã€‚<em>è¿™æ„å‘³ç€ç±»åŠ è½½å™¨é€šå¸¸ä¸ä¼šåŠ è½½ç±»å‹ï¼Œä»¥é˜²å…¶çˆ¶ç±»åŠ è½½ç¨‹åºçŸ¥é“å…·æœ‰ç›¸åŒåç§°çš„ç±»å‹ã€‚</em>ä¸ºäº†è¿™ä¸ªç›®çš„ï¼ŒByte Buddyæä¾›äº†ä¸€ä¸ªå­ç±»ä¼˜å…ˆçš„ç±»åŠ è½½å™¨çš„åˆ›å»ºåŠŸèƒ½ï¼Œå®ƒå°è¯•åœ¨æŸ¥è¯¢çˆ¶ç±»ä¹‹å‰è‡ªå·±åŠ è½½ä¸€ä¸ªç±»å‹ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿™ç§æ–¹æ³•ç±»ä¼¼äºä¸Šè¿°æ–¹æ³•ã€‚è¯·æ³¨æ„ï¼Œæ­¤æ–¹æ³•ä¸ä¼šè¦†ç›–çˆ¶ç±»åŠ è½½å™¨çš„ç±»å‹ï¼Œ<em>è€Œæ˜¯å½±å“æ­¤å…¶ä»–ç±»å‹ã€‚</em></p>
</li>
<li>
<p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åå°„æ¥å°†ç±»å‹æ³¨å…¥åˆ°ç°æœ‰çš„ <code>ClassLoader</code> ä¸­ã€‚é€šå¸¸ï¼Œç±»åŠ è½½å™¨è¢«è¦æ±‚ä»¥å…¶åç§°æä¾›ç»™å®šç±»å‹ã€‚ä½¿ç”¨åå°„ï¼Œæˆ‘ä»¬å¯ä»¥å›´ç»•è¿™ä¸ªåŸç†ï¼Œå¹¶è°ƒç”¨ä¸€ä¸ªprotectedæ–¹æ³•ï¼Œå°†ç±»æ·»åŠ åˆ°ç±»åŠ è½½å™¨ä¸­ï¼Œè€Œç±»åŠ è½½å™¨å®é™…ä¸Šå¹¶ä¸çŸ¥é“å¦‚ä½•å®šä½è¿™ä¸ªåŠ¨æ€ç±»ã€‚</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ä¸å¹¸çš„æ˜¯ï¼Œä¸Šé¢çš„æ–¹å¼æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š</p>
</div>
<div class="ulist">
<ul>
<li>
<p>å¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>ClassLoader</code>ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨å°±ä¼šå®šä¹‰ä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ã€‚æœ‰æ„ä¹‰çš„æ˜¯ï¼Œå¯ä»¥åŠ è½½ä¸¤ä¸ªå…·æœ‰ç›¸åŒåç§°çš„ç±»ï¼Œåªè¦è¿™äº›ç±»ç”±ä¸¤ä¸ªä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½å³å¯ã€‚å³ä½¿è¿™ä¸¤ä¸ªç±»ä»£è¡¨ç›¸åŒçš„ç±»å®ç°ï¼Œè¿™ä¸¤ä¸ªç±»ä¹Ÿä¸ä¼šè¢« Java è™šæ‹Ÿæœºè§†ä¸ºç›¸ç­‰ã€‚è¿™ä¸ªç­‰å¼çš„è§„åˆ™ä¹Ÿé€‚ç”¨äºJavaåŒ…ã€‚è¿™æ„å‘³ç€ä¸€ä¸ªç±» <code>example.Foo</code> ä¸èƒ½è®¿é—®å¦ä¸€ä¸ªç±» <code>example.Bar</code> çš„åŒ…ç§æœ‰çº§çš„æ–¹æ³•ï¼Œå¦‚æœä¸¤ä¸ªç±»ä¸æ˜¯ç”±ç›¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½çš„è¯ã€‚å¦å¤–ï¼Œå¦‚æœ <code>examâ€‹â€‹ple.Bar</code> æ‰©å±• <code>example.Foo</code>ï¼Œä»»ä½•è¦†ç›–çš„åŒ…ç§æœ‰çº§çš„æ–¹æ³•å°†å˜å¾—ä¸èµ·ä½œç”¨ï¼Œå°†ä¼šå§”æ‰˜ç»™åŸå§‹å®ç°ã€‚</p>
</li>
<li>
<p>æ¯å½“åŠ è½½ç±»æ—¶ï¼Œä¸€æ—¦å¼•ç”¨å¦ä¸€ç§ç±»å‹çš„ä»£ç æ®µè¢«è§£æï¼Œå…¶ç±»åŠ è½½å™¨å°±ä¼šæŸ¥æ‰¾è¯¥ç±»ä¸­å¼•ç”¨çš„ä»»ä½•ç±»å‹ã€‚è¿™ä¸ªæŸ¥æ‰¾ä¼šå§”æ‰˜ç»™åŒä¸€ä¸ªç±»åŠ è½½å™¨ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬åŠ¨æ€åˆ›å»ºä¸¤ä¸ªç±» <code>example.Foo</code> å’Œ <code>example.Bar</code>ã€‚å¦‚æœæˆ‘ä»¬å°† <code>example.Foo</code> æ³¨å…¥åˆ°ä¸€ä¸ªç°æœ‰çš„ç±»åŠ è½½å™¨ä¸­ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨å¯èƒ½ä¼šå°è¯•æ‰¾åˆ° <code>example.Bar</code>ã€‚ç„¶è€Œï¼Œè¿™ç§æŸ¥æ‰¾ä¼šå¤±è´¥ï¼Œå› ä¸ºåä¸€ç±»æ˜¯åŠ¨æ€åˆ›å»ºçš„ï¼Œå¯¹äºæˆ‘ä»¬åˆšæ³¨å…¥ <code>example.Foo</code> ç±»çš„ç±»åŠ è½½å™¨æ˜¯ä¸å¯è®¿é—®çš„ã€‚å› æ­¤ï¼Œ<em>åå°„æ–¹æ³•ä¸èƒ½ç”¨äºåœ¨ç±»åŠ è½½æœŸé—´å˜å¾—æœ‰æ•ˆçš„å¾ªç¯ä¾èµ–æ€§çš„ç±»ã€‚</em>å¹¸è¿çš„æ˜¯ï¼Œå¤§å¤šæ•° Java è™šæ‹Ÿæœºå®ç°ä¼šåœ¨ç¬¬ä¸€æ¬¡ä¸»åŠ¨ä½¿ç”¨æ—¶æƒ°æ€§åœ°è§£æå¼•ç”¨çš„ç±»ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆç±»æ³¨å…¥é€šå¸¸å¯ä»¥å·¥ä½œè€Œæ²¡æœ‰è¿™äº›é™åˆ¶ã€‚å¦å¤–åœ¨å®è·µä¸­ï¼Œç”± Byte Buddy åˆ›å»ºçš„ç±»é€šå¸¸ä¸ä¼šå—åˆ°è¿™ç§å¾ªç¯çš„å½±å“ã€‚</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>æ‚¨å¯èƒ½ä¼šè€ƒè™‘åˆ°é‡åˆ°å¾ªç¯ä¾èµ–å…³ç³»çš„å¯èƒ½æ€§ä¸æ‚¨ä¸€æ¬¡åˆ›å»ºä¸€ä¸ªåŠ¨æ€ç±»å‹ç›¸å…³è”ã€‚</em>ä½†æ˜¯ï¼ŒåŠ¨æ€åˆ›å»ºç±»å‹å¯èƒ½ä¼šè§¦å‘æ‰€è°“çš„è¾…åŠ©ç±»å‹çš„åˆ›å»ºã€‚è¿™äº›ç±»å‹ç”± Byte Buddy è‡ªåŠ¨åˆ›å»ºï¼Œä»¥æä¾›å¯¹æ‚¨æ­£åœ¨åˆ›å»ºçš„åŠ¨æ€ç±»å‹æ¥è®¿é—®ã€‚æˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚ä¸­è¯¦ç»†äº†è§£è¾…åŠ©ç±»å‹ï¼Œç°åœ¨ä¸ç”¨æ‹…å¿ƒã€‚ä½†æ˜¯ï¼Œç”±äºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬å»ºè®®æ‚¨é€šè¿‡åˆ›å»ºä¸€ä¸ªç‰¹å®šçš„ <code>ClassLoader</code> æ¥åŠ è½½åŠ¨æ€åˆ›å»ºçš„ç±»ï¼Œè€Œä¸æ˜¯å°†å®ƒä»¬æ³¨å…¥ç°æœ‰ç±»ã€‚</p>
</div>
<div class="paragraph">
<p>åˆ›å»º <code>DynamicType.Unloaded</code> ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ <code>ClassLoadingStrategy</code> åŠ è½½æ­¤ç±»å‹ã€‚<em>å¦‚æœæ²¡æœ‰æä¾›è¿™æ ·çš„ç­–ç•¥ï¼ŒByte Buddy ä¼šæ ¹æ®æä¾›çš„ç±»åŠ è½½å™¨æ¨æµ‹å‡ºè¿™æ ·çš„ç­–ç•¥ï¼Œå¹¶ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»åŠ è½½å™¨ï¼Œå…¶ä¸­ä¸èƒ½ä½¿ç”¨åå°„æ³¨å…¥ç±»å‹ï¼Œå¦åˆ™ä¸ºé»˜è®¤å€¼ã€‚</em>Byte Buddyæä¾›äº†å‡ ç§ç±»åŠ è½½ç­–ç•¥ï¼Œå…¶ä¸­æ¯ç§éƒ½éµå¾ªä¸Šè¿°æ¦‚å¿µä¹‹ä¸€ã€‚è¿™äº›ç­–ç•¥å®šä¹‰åœ¨ <code>ClassLoadingStrategy.Default</code> ä¸­ï¼Œå…¶ä¸­ <code>WRAPPER</code> ç­–ç•¥åˆ›å»ºä¸€ä¸ªæ–°çš„åŒ…è£… <code>ClassLoader</code>ï¼›<code>CHILD_FIRST</code> ç­–ç•¥åˆ›å»ºä¸€ä¸ªç±»ä¼¼äºç¬¬ä¸€ä¸ªå­ç±»ä¼˜å…ˆçš„ç±»åŠ è½½å™¨ï¼›<code>INJECTION</code> ç­–ç•¥ä½¿ç”¨åå°„æ³¨å…¥åŠ¨æ€ç±»å‹ã€‚ <code>WRAPPER</code> å’Œ <code>CHILD_FIRST</code> ç­–ç•¥ä¹Ÿå¯ä»¥åœ¨æ‰€è°“çš„<em>æ¸…å•ç‰ˆæœ¬</em>ä¸­ä½¿ç”¨ï¼Œå³ä½¿åœ¨åŠ è½½ç±»ä¹‹åï¼Œç±»å‹çš„äºŒè¿›åˆ¶æ ¼å¼ä¹Ÿè¢«ä¿ç•™ã€‚è¿™äº›æ›¿ä»£ç‰ˆæœ¬ä½¿å¾—ç±»åŠ è½½å™¨çš„ç±»çš„äºŒè¿›åˆ¶è¡¨ç¤ºå¯ä»¥é€šè¿‡ <code>ClassLoade::getResourceAsStream</code> æ–¹æ³•è®¿é—®ã€‚ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œè¿™éœ€è¦è¿™äº›ç±»åŠ è½½å™¨æ¥ç»´æŠ¤å¯¹ç±»çš„å®Œæ•´äºŒè¿›åˆ¶è¡¨ç¤ºçš„å¼•ç”¨ï¼Œè¿™å°†å ç”¨ Java è™šæ‹Ÿæœºå †ä¸Šçš„ç©ºé—´ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æ‰“ç®—å®é™…è®¿é—®äºŒè¿›åˆ¶æ ¼å¼ï¼Œåˆ™åº”ä»…ä½¿ç”¨æ¸…å•ç‰ˆæœ¬ã€‚ç”±äº <code>INJECTION</code> ç­–ç•¥é€šè¿‡åå°„å·¥ä½œï¼Œå¹¶ä¸”æ— æ³•æ›´æ”¹ <code>ClassLoader::getResourceAsStream</code> æ–¹æ³•çš„è¯­ä¹‰ï¼Œå› æ­¤å®ƒåœ¨æ¸…å•ç‰ˆæœ¬ä¸­è‡ªç„¶ä¸å¯ç”¨ã€‚</p>
</div>
<div class="paragraph">
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ç±»åŠ è½½çš„å®é™…æ“ä½œï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteBuddy</span><span class="o">()</span>
  <span class="o">.</span><span class="na">subclass</span><span class="o">(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">make</span><span class="o">()</span>
  <span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="nc">ClassLoadingStrategy</span><span class="o">.</span><span class="na">Default</span><span class="o">.</span><span class="na">WRAPPER</span><span class="o">)</span>
  <span class="o">.</span><span class="na">getLoaded</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºå¹¶åŠ è½½äº†ä¸€ä¸ªç±»ã€‚æˆ‘ä»¬ä½¿ç”¨ <code>WRAPPER</code> ç­–ç•¥æ¥åŠ è½½é€‚åˆå¤§å¤šæ•°æƒ…å†µçš„ç±»ï¼Œå°±åƒæˆ‘ä»¬ä¹‹å‰æåˆ°çš„é‚£æ ·ã€‚æœ€åï¼Œ<code>getLoaded</code> æ–¹æ³•è¿”å›ä¸€ä¸ª Java <code>Class</code> çš„å®ä¾‹ï¼Œå®ƒå°±è¡¨ç¤ºç°åœ¨åŠ è½½çš„åŠ¨æ€ç±»ã€‚</p>
</div>
<div class="paragraph">
<p><em>è¯·æ³¨æ„ï¼ŒåŠ è½½ç±»æ—¶ï¼Œé€šè¿‡åº”ç”¨å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡çš„ <code>ProtectionDomain</code> æ¥æ‰§è¡Œé¢„å®šä¹‰çš„ç±»åŠ è½½ç­–ç•¥ã€‚æˆ–è€…ï¼Œæ‰€æœ‰é»˜è®¤ç­–ç•¥é€šè¿‡è°ƒç”¨ <code>withProtectionDomain</code> æ–¹æ³•æ¥æä¾›æ˜ç¡®ä¿æŠ¤åŸŸçš„è§„èŒƒã€‚ä½¿ç”¨å®‰å…¨ç®¡ç†å‘˜ï¼ˆsecurity managerï¼‰æˆ–ä½¿ç”¨å·²ç­¾åçš„ Jar ä¸­å®šä¹‰çš„ç±»æ—¶ï¼Œå®šä¹‰æ˜¾å¼ä¿æŠ¤åŸŸå¾ˆé‡è¦ã€‚</em></p>
</div>
</div>
<div class="sect2">
<h3 id="reloading-a-class"><a class="anchor" href="#reloading-a-class"></a>é‡æ–°åŠ è½½ç±»</h3>
<div class="paragraph">
<p>åœ¨å‰é¢ç« èŠ‚ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ Byte Buddy å»é‡å®šä¹‰æˆ–è€…é‡å®šåŸºåº•ä¸€ä¸ªå·²å­˜åœ¨çš„ç±»ã€‚ç„¶è€Œï¼Œåœ¨ Java ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œé€šå¸¸ä¸å¯èƒ½ä¿è¯ç‰¹å®šçš„ç±»æ²¡æœ‰è¢«åŠ è½½ã€‚ï¼ˆæ­¤å¤–ï¼ŒByte Buddyç›®å‰åªå°†åŠ è½½çš„ç±»ä½œä¸ºå®ƒçš„å‚æ•°ï¼Œè¿™å°†åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­æ”¹å˜ï¼Œç°æœ‰çš„APIå¯ä»¥ç”¨äºåŒç­‰åœ°å¤„ç†æœªåŠ è½½çš„ç±»ã€‚ï¼‰ç”±äº Java è™šæ‹Ÿæœºçš„â€œçƒ­æ›¿æ¢ï¼ˆHotSwapï¼‰â€ç‰¹æ€§ï¼Œå³ä½¿åœ¨åŠ è½½åä¹Ÿå¯ä»¥é‡æ–°å®šä¹‰ç°æœ‰ç±»ã€‚é€šè¿‡ Byte Buddy çš„ <code>ClassRelodingsTrategy</code> å³å¯ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚è®©æˆ‘ä»¬é€šè¿‡é‡æ–°å®šä¹‰ç±» <code>Foo</code> æ¥æ¼”ç¤ºè¿™ç§ç­–ç•¥ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="nf">m</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="s">"foo"</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Bar</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="nf">m</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="s">"bar"</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä½¿ç”¨ Byte Buddyï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥è½»æ¾åœ°å°†ç±» <code>Foo</code> é‡æ–°å®šä¹‰ä¸º <code>Bar</code>ã€‚ä½¿ç”¨çƒ­æ›¿æ¢ï¼Œè¿™ä¸ªé‡å®šä¹‰ç”šè‡³å¯ä»¥åº”ç”¨äºå…ˆå‰å­˜åœ¨çš„å®ä¾‹ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="nc">ByteBuddyAgent</span><span class="o">.</span><span class="na">install</span><span class="o">();</span>
<span class="nc">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Foo</span><span class="o">();</span>
<span class="k">new</span> <span class="nf">ByteBuddy</span><span class="o">()</span>
  <span class="o">.</span><span class="na">redefine</span><span class="o">(</span><span class="nc">Bar</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="nc">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span>
  <span class="o">.</span><span class="na">make</span><span class="o">()</span>
  <span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="nc">ClassReloadingStrategy</span><span class="o">.</span><span class="na">fromInstalledAgent</span><span class="o">());</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">foo</span><span class="o">.</span><span class="na">m</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">"bar"</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
ä¸ºäº†æ–¹ä¾¿å¯¹æ¯”åŸæ–‡ä¸ç¿»è¯‘ï¼Œä»¥æ±‚æœ‰å¿—ä¹‹å£«æ”¹è¿›ç¿»è¯‘ï¼Œä»¥ä¸‹å¢åŠ è‹±è¯­åŸæ–‡ï¼ŒåŸæ–‡ä¸‹é¢å¢åŠ ç¿»è¯‘ã€‚
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>HotSwap is only accessible using a <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.instrument/java/lang/instrument/package-summary.html" target="_blank" rel="noopener">so-called Java agent</a>. Such an agent can be installed by either specifying it on the startup of the Java virtual machine by using the <code>-javaagent</code> parameter where the parameter&#8217;s argument needs to be Byte Buddy&#8217;s agent jar which can be <a href="https://search.maven.org/search?q=a:byte-buddy-agent" target="_blank" rel="noopener">downloaded from Maven Central</a>. However, when a Java application is run from a JDK-installation of the Java virtual machine, Byte Buddy can load a Java agent even after application startup by <code>ByteBuddyAgent.installOnOpenJDK()</code>. Because class redefinition is mostly used to implement tooling or testing, this can be a very convenient alternative. Since Java 9, an agent installation is also possible at runtime without a JDK-installation.</p>
</div>
<div class="paragraph">
<p>çƒ­æ›¿æ¢ä»…èƒ½é€šè¿‡æ‰€è°“çš„ <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.instrument/java/lang/instrument/package-summary.html" target="_blank" rel="noopener">Java Agent</a> è¿›è¡Œè®¿é—®ã€‚<em>å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>-javaagent</code> å‚æ•°åœ¨Java è™šæ‹Ÿæœºçš„å¯åŠ¨æ—¶æŒ‡å®š Java Agentï¼Œå…¶ä¸­å‚æ•°å€¼æ˜¯ä½¿ç”¨ Byte Buddy å¼€å‘çš„ Jar åŒ…ï¼Œè€Œ Byte Buddy ç›¸å…³ä¾èµ–åˆ™å¯ä»¥ä» <a href="https://search.maven.org/search?q=a:byte-buddy-agent" target="_blank" rel="noopener">Maven Central</a> ä¸‹è½½ã€‚</em>ç„¶è€Œï¼Œå½“ Java åº”ç”¨ç¨‹åºæ˜¯åœ¨ä» JDK å®‰è£…çš„ Java è™šæ‹Ÿæœºä¸­è¿è¡Œæ—¶ï¼ŒByte Buddy ç”šè‡³å¯ä»¥é€šè¿‡ <code>ByteBuddyAgent.installOnOpenJDK()</code> åœ¨å¯åŠ¨åº”ç”¨ç¨‹åºååŠ è½½ Java Agentã€‚å› ä¸ºç±»é‡å®šä¹‰ä¸»è¦ç”¨äºå®ç°å·¥å…·æˆ–æµ‹è¯•ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ç§éå¸¸æ–¹ä¾¿çš„æ›¿ä»£æ–¹æ³•ã€‚ä» Java 9 å¼€å§‹ï¼Œåœ¨è¿è¡Œæ—¶ä¸éœ€è¦ JDK å®‰è£…ä¹Ÿå¯ä»¥è¿›è¡Œä»£ç†å®‰è£…ã€‚</p>
</div>
<div class="paragraph">
<p>One thing that might first appear counter-intuitive about the above example is the fact that Byte Buddy is instructed to redefine the <code>Bar</code> type where the <code>Foo</code> type is eventually redefined. The Java virtual machine identifies types by their name and a class loader. Therefore, by renaming <code>Bar</code> to <code>Foo</code> and applying this definition, we eventually redefine the type we renamed <code>Bar</code> into. It is of course equally possible to redefine Foo directly without renaming a different type.</p>
</div>
<div class="paragraph">
<p>å…³äºä¸Šé¢çš„ç¤ºä¾‹ï¼Œé¦–å…ˆçœ‹èµ·æ¥å¯èƒ½ä¸ç›´è§‰ç›¸åçš„ä¸€ä»¶äº‹æ˜¯ï¼ŒByte Buddy è¢«æŒ‡ç¤ºé‡æ–°å®šä¹‰ <code>Bar</code> ç±»å‹ï¼Œè€Œ <code>Foo</code> ç±»å‹æœ€ç»ˆè¢«é‡æ–°å®šä¹‰ã€‚Java è™šæ‹Ÿæœºé€šè¿‡ç±»å‹çš„åç§°å’Œç±»åŠ è½½å™¨æ¥è¯†åˆ«ç±»å‹ã€‚å› æ­¤ï¼Œé€šè¿‡å°† <code>Bar</code> é‡å‘½åä¸º <code>Foo</code> å¹¶åº”ç”¨æ­¤å®šä¹‰ï¼Œæˆ‘ä»¬æœ€ç»ˆé‡æ–°å®šä¹‰äº†å°† <code>Bar</code> é‡å‘½åä¸ºçš„ç±»å‹ã€‚å½“ç„¶ï¼ŒåŒæ ·å¯ä»¥ç›´æ¥é‡æ–°å®šä¹‰ <code>Foo</code>ï¼Œè€Œæ— éœ€é‡å‘½åå…¶ä»–ç±»å‹ã€‚</p>
</div>
<div class="paragraph">
<p>Using Java&#8217;s HotSwap feature, there is however one huge drawback. Current implementations of HotSwap require that the redefined classes apply the same class schema both before and after a class redefinition. This means that it is not allowed to add methods or fields when reloading classes. We already discussed that Byte Buddy defines copies of the original methods for any rebased class such that class rebasing does not work for the <code>ClassReloadingStrategy</code>. Also, class redefinition does not work for classes with an explicit class initializer method (a static block within a class) because this initializer needs to be copied into an extra method as well. Unfortunately OpenJDK has withdrawn from <a href="https://openjdk.org/jeps/159" target="_blank" rel="noopener">extending HotSwap functionality</a>, so there is no way to work around this limitation using the HotSwap feature. In the mean time, Byte Buddy&#8217;s HotSwap support can be used for corner-cases where it seems useful. Otherwise, class rebasing and redefinition can be a convenient feature when enhancing existing classes from for example a build script.</p>
</div>
<div class="paragraph">
<p>ç„¶è€Œï¼Œä½¿ç”¨ Java çš„çƒ­äº¤æ¢åŠŸèƒ½ï¼Œæœ‰ä¸€ä¸ªå·¨å¤§çš„ç¼ºç‚¹ã€‚å½“å‰çš„çƒ­æ›¿æ¢å®ç°è¦æ±‚é‡å®šä¹‰çš„ç±»åœ¨é‡å®šä¹‰ä¹‹å‰å’Œä¹‹åéƒ½åº”ç”¨ç›¸åŒçš„æ¨¡å¼ã€‚è¿™æ„å‘³ç€åœ¨é‡è½½ç±»æ—¶ä¸å…è®¸æ·»åŠ æ–¹æ³•æˆ–å­—æ®µã€‚æˆ‘ä»¬å·²ç»è®¨è®ºè¿‡ï¼ŒByte Buddy ä¸ºä»»ä½•é‡å®šåŸºç±»å®šä¹‰äº†åŸå§‹æ–¹æ³•çš„å‰¯æœ¬ï¼Œè¿™æ ·é‡å®šåŸºåº•çš„ç±»ï¼Œå¯¹äº <code>ClassReloadingStrategy</code> æ¥è¯´ï¼Œéƒ½æ˜¯ä¸é€‚ç”¨çš„ã€‚åŒæ ·ï¼Œç±»é‡å®šä¹‰ä¸é€‚ç”¨äºå…·æœ‰æ˜¾å¼ç±»åˆå§‹åŒ–å™¨æ–¹æ³•(ç±»ä¸­çš„é™æ€å—)çš„ç±»ï¼Œå› ä¸ºè¿™ä¸ªåˆå§‹åŒ–å™¨è¿˜éœ€è¦å¤åˆ¶åˆ°ä¸€ä¸ªé¢å¤–çš„æ–¹æ³•ä¸­ã€‚ä¸å¹¸çš„æ˜¯ï¼ŒOpenJDK å·²ç»é€€å‡ºäº† <a href="https://openjdk.org/jeps/159" target="_blank" rel="noopener">å¯¹çƒ­æ›¿æ¢åŠŸèƒ½çš„æ‰©å±•</a>ï¼Œå› æ­¤ä½¿ç”¨çƒ­æ›¿æ¢åŠŸèƒ½å°±æ— æ³•ç»•è¿‡è¿™ä¸€é™åˆ¶ã€‚åŒæ—¶ï¼ŒByte Buddyçš„çƒ­æ›¿æ¢å¯¹äºä¸€äº›æç«¯æƒ…å†µï¼Œä¼¼ä¹ç‰¹åˆ«æœ‰ç”¨ã€‚åŒæ—¶ï¼Œå½“å¢åŠ ç°æœ‰ç±»æ—¶ï¼Œæ¯”å¦‚ä¸€ä¸ªæ„å»ºè„šæœ¬ï¼Œç±»çš„é‡å®šåŸºåº•å’Œç±»çš„é‡å®šä¹‰å°†æ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„ç‰¹æ•ˆã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="working-with-unloaded-classes"><a class="anchor" href="#working-with-unloaded-classes"></a>æ“ä½œæ²¡æœ‰åŠ è½½çš„ç±»</h3>
<div class="paragraph">
<p>With this realization about the limits of Java&#8217;s HotSwap feature, one might think that the only meaningful application of the <code>rebase</code> and <code>redefinition</code> instructions would be during build time. By applying build-time manipulation, one can assert that a processed class is not loaded before its initial class loading simply because this class loading is accomplished in a different instance of the JVM. Byte Buddy is however equally capable of working with classes that were not yet loaded. For this, Byte Buddy abstracts over Java&#8217;s reflection API such that a <code>Class</code> instance is for example internally represented by an instance of a <code>TypeDescription</code>. As a matter of fact, Byte Buddy only knows how to process a provided <code>Class</code> by an adapter that implements the TypeDescription interface. The big advantage over this abstraction is that information on classes do not need to be provided by a <code>ClassLoader</code> but can be provided by any other sources.</p>
</div>
<div class="paragraph">
<p>é€šè¿‡å¯¹ Java â€œçƒ­æ›¿æ¢â€ç‰¹æ€§çš„é™åˆ¶çš„è®¤è¯†ï¼Œäººä»¬å¯èƒ½ä¼šè®¤ä¸ºï¼Œç±»å‹é‡å®šåŸºåº•å’Œç±»å‹é‡å®šä¹‰çš„å”¯ä¸€æœ‰æ„ä¹‰çš„åº”ç”¨ä¹‹å¤„æ˜¯åœ¨æ„å»ºæ—¶ã€‚é€šè¿‡åº”ç”¨æ„å»ºæ—¶é—´æ“ä½œï¼Œå¯ä»¥æ–­è¨€ï¼Œåœ¨åˆå§‹ç±»åŠ è½½ä¹‹å‰ä¸ä¼šåŠ è½½å·²å¤„ç†çš„ç±»ï¼Œå› ä¸ºè¯¥ç±»çš„åŠ è½½æ˜¯åœ¨ JVM çš„ä¸åŒå®ä¾‹ä¸­å®Œæˆçš„ã€‚ç„¶è€Œï¼ŒByte Buddy åŒæ ·èƒ½å¤Ÿå¤„ç†å°šæœªåŠ è½½çš„ç±»ã€‚ä¸ºæ­¤ï¼ŒByte Buddy é€šè¿‡ Java çš„åå°„ API è¿›è¡ŒæŠ½è±¡ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ª <code>Class</code> å®ä¾‹åœ¨ Byte Buddy å†…ç”±ä¸€ä¸ª <code>TypeDescription</code> å®ä¾‹æ¥è¡¨ç¤ºã€‚äº‹å®ä¸Šï¼ŒByte Buddy åªçŸ¥é“å¦‚ä½•å¤„ç†ç”±å®ç° <code>TypeDescription</code> æ¥å£çš„é€‚é…å™¨æä¾›çš„ç±»ã€‚ä¸æ­¤æŠ½è±¡ç›¸æ¯”ï¼Œæœ€å¤§çš„ä¼˜åŠ¿åœ¨äºï¼Œç±»çš„ä¿¡æ¯ä¸éœ€è¦ç”± <code>ClassLoader</code> æä¾›ï¼Œè€Œå¯ä»¥ç”±ä»»ä½•å…¶ä»–æ¥æºæä¾›ã€‚</p>
</div>
<div class="paragraph">
<p>Byte Buddy provides a canonical manner for getting hold of a class&#8217;s <code>TypeDescription</code> using a <code>TypePool</code>. A default implementation of such a pool is of course also provided. This <code>TypePool.Default</code> implementation parses the binary format of a class and represents it as the required <code>TypeDescription</code>. Similarly to a <code>ClassLoader</code> it maintains a cache for represented classes which is also customizable. Also, it normally retrieves the binary format of a class from a <code>ClassLoader</code>, however without instructing it to load this class.</p>
</div>
<div class="paragraph">
<p>Byte Buddy æä¾›äº†ä¸€ç§ä½¿ç”¨ <code>TypePool</code> è·å–ç±»çš„ <code>TypeDescription</code> çš„è§„èŒƒæ–¹å¼ã€‚å½“ç„¶ä¹Ÿæä¾›äº†è¿™æ ·ä¸€ä¸ªæ­¤ç±»å‹æ± çš„é»˜è®¤å®ç°ã€‚<code>TypePool.Default</code> å®ç°è§£æç±»çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå¹¶å°†å…¶è¡¨ç¤ºä¸ºæ‰€éœ€çš„ <code>TypeDescription</code>ã€‚ä¸ <code>ClassLoader</code> ç±»ä¼¼ï¼Œå®ƒä¸ºæ‰€è¡¨ç¤ºçš„ç±»ç»´æŠ¤ä¸€ä¸ªç¼“å­˜ï¼Œè¿™ä¹Ÿæ˜¯å¯å®šåˆ¶çš„ã€‚æ­¤å¤–ï¼Œå®ƒé€šå¸¸ä» <code>ClassLoader</code> ä¸­æ£€ç´¢ç±»çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œä½†æ˜¯æ— éœ€æŒ‡ç¤ºåŠ è½½æ­¤ç±»ã€‚</p>
</div>
<div class="paragraph">
<p>The Java virtual machine only loads a class on its first usage. As a consequence, we can for example safely redefine a class such as</p>
</div>
<div class="paragraph">
<p>Java è™šæ‹Ÿæœºä»…åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶åŠ è½½ç±»ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°é‡æ–°å®šä¹‰ä¸€ä¸ªç±»ï¼Œä¾‹å¦‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">foo</span><span class="o">;</span>
<span class="kd">class</span> <span class="nc">Bar</span> <span class="o">{</span> <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>right at program startup before running any other code:</p>
</div>
<div class="paragraph">
<p>åœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œåœ¨è¿è¡Œä»»ä½•å…¶ä»–ä»£ç ä¹‹å‰ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="kd">class</span> <span class="nc">MyApplication</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">TypePool</span> <span class="n">typePool</span> <span class="o">=</span> <span class="nc">TypePool</span><span class="o">.</span><span class="na">Default</span><span class="o">.</span><span class="na">ofSystemLoader</span><span class="o">();</span>
    <span class="nc">Class</span> <span class="n">type</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteBuddy</span><span class="o">()</span>
      <span class="o">.</span><span class="na">redefine</span><span class="o">(</span><span class="n">typePool</span><span class="o">.</span><span class="na">describe</span><span class="o">(</span><span class="s">"foo.Bar"</span><span class="o">).</span><span class="na">resolve</span><span class="o">(),</span> <span class="c1">// do not use 'Bar.class'</span>
                <span class="nc">ClassFileLocator</span><span class="o">.</span><span class="na">ForClassLoader</span><span class="o">.</span><span class="na">ofClassPath</span><span class="o">())</span>
      <span class="o">.</span><span class="na">defineField</span><span class="o">(</span><span class="s">"qux"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// we learn more about defining fields later</span>
      <span class="o">.</span><span class="na">make</span><span class="o">()</span>
      <span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">ClassLoadingStrategy</span><span class="o">.</span><span class="na">BOOTSTRAP_LOADER</span><span class="o">,</span> <span class="nc">ClassLoadingStrategy</span><span class="o">.</span><span class="na">Default</span><span class="o">.</span><span class="na">WRAPPER</span><span class="o">)</span>
      <span class="o">.</span><span class="na">getLoaded</span><span class="o">();</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"qux"</span><span class="o">),</span> <span class="n">notNullValue</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
è¿™ä¸ªç¤ºä¾‹æœ‰é”™ï¼å·²ç»åœ¨ GitHub ä¸Šæäº¤äº† Issueï¼š <a href="https://github.com/raphw/byte-buddy/issues/1293" target="_blank" rel="noopener">The example in "Working with unloaded classes" is wrong.</a>ã€‚
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By explicitly loading the redefined class before its first use in the assertion statement, we forestall the JVM&#8217;s built-in class loading. This way, the redefined definition of <code>foo.Bar</code> is loaded and used throughout our application&#8217;s runtime. Note however that we do not reference the class by a class literal when we use the <code>TypePool</code> to provide a description. If we did use a class literal for <code>foo.Bar</code>, the JVM would have loaded this class before we had a chance to redefine it and our redefinition attempt would be without effect. Also, note that when working with unloaded classes, we further need to specify a <code>ClassFileLocator</code> which allows to locate a class&#8217;s class file. In the example above, we simply create a class file locator which scans the running application&#8217;s class path for such files.</p>
</div>
<div class="paragraph">
<p>é€šè¿‡åœ¨æ–­è¨€è¯­å¥ä¸­ã€é¦–æ¬¡ä½¿ç”¨ä¹‹å‰æ˜¾å¼åŠ è½½é‡å®šä¹‰ç±»å‹ï¼Œæˆ‘ä»¬é˜»æ­¢äº† JVM å†…ç½®çš„ç±»åŠ è½½ã€‚è¿™æ ·ï¼Œç»è¿‡ç±»å‹é‡å®šä¹‰çš„ <code>foo.Bar</code>ï¼Œå°±å¯ä»¥åœ¨åº”ç”¨ç¨‹åºçš„æ•´ä¸ªè¿è¡Œæ—¶è¢«åŠ è½½å’Œä½¿ç”¨ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œåœ¨ä½¿ç”¨ <code>TypePool</code> æä¾›ç±»å‹æè¿°æ—¶ï¼Œå¹¶æ²¡æœ‰é€šè¿‡ç±»åå¼•ç”¨ç±»ã€‚å¦‚æœç¡®å®é€šè¿‡ç±»åå¼•ç”¨äº†ç±»ï¼Œåˆ™ JVM åœ¨æœ‰æœºä¼šè¿›è¡Œé‡å®šä¹‰å®ƒä¹‹å‰å°±å·²ç»åŠ è½½äº†è¿™ä¸ªç±»ï¼Œé‚£ä¹ˆç±»å‹é‡å®šä¹‰çš„å°è¯•å°†æ— æ•ˆã€‚å¦å¤–ï¼Œè¯·æ³¨æ„ï¼Œåœ¨å¤„ç†æœªåŠ è½½çš„ç±»æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŒ‡å®šä¸€ä¸ª <code>ClassFileLocator</code>ï¼Œå®ƒå…è®¸å®šä½ç±»çš„ç±»æ–‡ä»¶ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åªéœ€åˆ›å»ºä¸€ä¸ªç±»æ–‡ä»¶å®šä½å™¨ï¼Œç”¨äºæ‰«ææ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„ç±»è·¯å¾„ä»¥æŸ¥æ‰¾æ­¤ç±»æ–‡ä»¶ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="creating-java-agents"><a class="anchor" href="#creating-java-agents"></a>åˆ›å»º Java Agents</h3>
<div class="paragraph">
<p>When an application grows bigger and becomes more modular, applying such a transformation at a specific program point is of course a cumbersome constraint to enforce. And there is indeed a better way to apply such class redefinitions on demand. Using a Java agent, it is possible to directly intercept any class loading activity that is conducted within a Java application. A Java agent is implemented as a simple jar file with an entry point that is specified in this jar file&#8217;s manifest file as it is described under the linked resource. Using Byte Buddy, the implementation of such an agent is straight forward by using an <code>AgentBuilder</code>. Assuming that we previously defined a simple annotation named <code>ToString</code>, it would be trivial to implement <code>toString</code> methods for all annotated classes simply by implementing the Agent&#8217;s <code>premain</code> method as follows:</p>
</div>
<div class="paragraph">
<p>å½“åº”ç”¨ç¨‹åºå˜å¾—æ›´å¤§ã€æ›´æ¨¡å—åŒ–æ—¶ï¼Œåœ¨ç‰¹å®šçš„ç¨‹åºç‚¹åº”ç”¨è¿™æ ·çš„è½¬æ¢å½“ç„¶æ˜¯ä¸€ä¸ªéš¾ä»¥æ‰§è¡Œçš„çº¦æŸã€‚ç¡®å®æœ‰æ›´å¥½çš„æ–¹æ³•å¯ä»¥æŒ‰éœ€åº”ç”¨æ­¤ç±»ç±»å‹é‡å®šä¹‰ã€‚ä½¿ç”¨ <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html" target="_blank" rel="noopener">Java Agent</a>ï¼Œå¯ä»¥ç›´æ¥æ‹¦æˆª Java åº”ç”¨ç¨‹åºä¸­æ‰§è¡Œçš„ä»»ä½•ç±»åŠ è½½æ´»åŠ¨ã€‚Java ä»£ç†è¢«å®ç°ä¸ºä¸€ä¸ªç®€å•çš„ Jar æ–‡ä»¶ï¼Œå…¶å…¥å£ç‚¹åœ¨è¯¥ Jar æ–‡ä»¶çš„æ¸…å•æ–‡ä»¶ä¸­æŒ‡å®šï¼Œæ­£å¦‚åœ¨é“¾æ¥èµ„æºä¸­æè¿°çš„é‚£æ ·ã€‚ä½¿ç”¨ Byte Buddyï¼Œé€šè¿‡ä½¿ç”¨ <code>AgentBuilder</code> ç›´æ¥å®ç°æ­¤ç±»ä»£ç†ã€‚å‡è®¾æˆ‘ä»¬ä»¥å‰å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>ToString</code> çš„ç®€å•æ³¨è§£ï¼Œé‚£ä¹ˆåªéœ€ Java Agent çš„ <code>premain</code> æ–¹æ³•ï¼Œå°±å¯ä»¥ä¸ºæ‰€æœ‰å¸¦æ³¨è§£çš„ç±»å®ç° <code>toString</code> æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤º:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="kd">class</span> <span class="nc">ToStringAgent</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">premain</span><span class="o">(</span><span class="nc">String</span> <span class="n">arguments</span><span class="o">,</span> <span class="nc">Instrumentation</span> <span class="n">instrumentation</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">AgentBuilder</span><span class="o">.</span><span class="na">Default</span><span class="o">()</span>
        <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="n">isAnnotatedWith</span><span class="o">(</span><span class="nc">ToString</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
        <span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="k">new</span> <span class="nc">AgentBuilder</span><span class="o">.</span><span class="na">Transformer</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="nc">DynamicType</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">transform</span><span class="o">(</span><span class="nc">DynamicType</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span><span class="o">,</span>
                                              <span class="nc">TypeDescription</span> <span class="n">typeDescription</span><span class="o">,</span>
                                              <span class="nc">ClassLoader</span> <span class="n">classloader</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">named</span><span class="o">(</span><span class="s">"toString"</span><span class="o">))</span>
                      <span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="nc">FixedValue</span><span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="s">"transformed"</span><span class="o">));</span>
      <span class="o">}</span>
    <span class="o">}).</span><span class="na">installOn</span><span class="o">(</span><span class="n">instrumentation</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="loading-classes-in-android-applications"><a class="anchor" href="#loading-classes-in-android-applications"></a>åœ¨ Android åº”ç”¨ä¸­åŠ è½½ç±»</h3>

</div>
<div class="sect2">
<h3 id="working-with-generic-types"><a class="anchor" href="#working-with-generic-types"></a>ä½¿ç”¨æ³›å‹ç±»</h3>

</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>â†Â Previous:Â <a href="preliminary.html">ä¸ºä»€ä¹ˆéœ€è¦åœ¨è¿è¡Œæ—¶ç”Ÿæˆä»£ç ï¼Ÿ</a>Â | â†‘Â Up:Â <a href="index.html">Byte Buddy æ•™ç¨‹ &lt;sup&gt;Alpha&lt;/sup</a>&gt;Â | Next:Â <a href="fields-and-methods.html">å±æ€§å’Œæ–¹æ³•</a>Â â†’</p>
</div>
</div>
<div id="footer">
<div id="footer-text">
V 0.1.0<br>
æœ€åæ›´æ–°æ—¶é—´ 2022-09-08 01:34:25 UTC
</div>
</div>
</body>
</html>